<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Deep dive into Kubernetes custom controllers</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/blog/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="You'll find all my tech posts here" />
    <link rel="shortcut icon" href="/blog//assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="/blog/deep-dive-into-kubernetes-custom-controllers" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Nomad's Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Deep dive into Kubernetes custom controllers" />
    <meta property="og:description" content="Kubernetes offers a rich ecosystem of extension points that allow developers to tailor and extend its functionality. Among these ability to implement Custom Controllers emerge as a powerful mechanism for extending Kubernetes with your own “Kubernetes logic”. While there are frameworks and tools like Kubebuilder and OperatorSDK that abstracts away" />
    <meta property="og:url" content="/blog/deep-dive-into-kubernetes-custom-controllers" />
    <meta property="og:image" content="/blog/assets/images/deep-dive-kubernetes-controllers-cover.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/lahiru97udayanga" />
    <meta property="article:author" content="https://www.facebook.com/lahiru97udayanga" />
    <meta property="article:published_time" content="2023-09-30T00:00:00+00:00" />
    <meta property="article:modified_time" content="2023-09-30T00:00:00+00:00" />
    <meta property="article:tag" content="Tech" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Deep dive into Kubernetes custom controllers" />
    <meta name="twitter:description" content="Kubernetes offers a rich ecosystem of extension points that allow developers to tailor and extend its functionality. Among these ability to implement Custom Controllers emerge as a powerful mechanism for extending Kubernetes with your own “Kubernetes logic”. While there are frameworks and tools like Kubebuilder and OperatorSDK that abstracts away" />
    <meta name="twitter:url" content="/blog/" />
    <meta name="twitter:image" content="/blog/assets/images/deep-dive-kubernetes-controllers-cover.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Nomad's Blog" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Tech" />
    <meta name="twitter:site" content="@NomadXDDDD" />
    <meta name="twitter:creator" content="@NomadXDDDD" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Nomad's Blog",
        "logo": "/blog//assets/images/blog-icon.png"
    },
    "url": "/blog/deep-dive-into-kubernetes-custom-controllers",
    "image": {
        "@type": "ImageObject",
        "url": "/blog/assets/images/deep-dive-kubernetes-controllers-cover.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/blog/deep-dive-into-kubernetes-custom-controllers"
    },
    "description": "Kubernetes offers a rich ecosystem of extension points that allow developers to tailor and extend its functionality. Among these ability to implement Custom Controllers emerge as a powerful mechanism for extending Kubernetes with your own “Kubernetes logic”. While there are frameworks and tools like Kubebuilder and OperatorSDK that abstracts away"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Deep dive into Kubernetes custom controllers" href="/blog/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="/blog/"><img src="/blog//assets/images/blog-icon.png" alt="Nomad's Blog" /></a>
            
        
        
            <ul class="nav" role="menu">
  <li class="nav-getting-started" role="menuitem">
    <a href="/blog/tag/tech/">Tech</a>
  </li>
  <li class="nav-home" role="menuitem">
    <a href="/blog/tag/random/">Random</a>
  </li>
  <li class="nav-try-ghost" role="menuitem">
    <a href="/blog/tag/travel/">Travel</a>
  </li>
  <li class="nav-about" role="menuitem">
    <a href="/blog/about/">About</a>
  </li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-fb" href="https://facebook.com/lahiru97udayanga" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
</a>
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/NomadXDDDD" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-tech post ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="30 September 2023">30 September 2023</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/blog/tag/tech/'>TECH</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Deep dive into Kubernetes custom controllers</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/blog/assets/images/deep-dive-kubernetes-controllers-cover.jpg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Kubernetes offers a rich ecosystem of <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/">extension points</a> that allow developers to tailor and extend its functionality. Among these ability to implement Custom Controllers emerge as a powerful mechanism for extending Kubernetes with your own “Kubernetes logic”. While there are frameworks and tools like <a href="https://github.com/kubernetes-sigs/kubebuilder">Kubebuilder</a> and <a href="https://sdk.operatorframework.io/">OperatorSDK</a> that abstracts away the complexity of implementing custom controllers, understanding how custom controllers operate at a fundamental level is crucial for those who wish to harness the full potential of Kubernetes. In this article, we will go through how custom controllers work behind the scenes and how you can leverage the basic building blocks of custom controllers for your use cases.</p>

<h3 id="table-of-content">Table of Content</h3>

<ul>
  <li><a href="#kubernetes-controller-overview">Kubernetes Controller Overview</a></li>
  <li><a href="#kubernetes-custom-controllers">Kubernetes Custom Controllers</a></li>
  <li><a href="#building-blocks-of-a-kubernetes-custom-controller">Building blocks of a Kubernetes custom controller</a></li>
  <li><a href="#internal-functionality-of-a-kubernetes-custom-controller">Internal functionality of a Kubernetes custom controller</a></li>
  <li><a href="#summary">Summary</a></li>
</ul>

<h4 id="kubernetes-controller-overview">Kubernetes Controller Overview</h4>

<p>Controllers serve as the intelligent core or the brain behind Kubernetes by orchestrating and coordinating the lifecycle of resources to ensure the desired state of applications. When resources like Pods, Deployments, Replicasets are created, the relevant controllers respond by performing the required actions to match the current state of the resource with the desired state of the resource.</p>

<p>For instance, consider the scenario of creating a ReplicaSet using kubectl. The ReplicaSet controller promptly detects this action and delegates the task to the kube-scheduler, which schedules the desired number of pods. Once these pods are up and running, the ReplicaSet controller continuously monitors their status through the Kubernetes API server. If, for any reason, a pod terminates unexpectedly, the ReplicaSet controller initiates a request to the kube-scheduler to replace the terminated pod, ensuring that the desired replica count is maintained.</p>

<p>Similarly, Kubernetes ships with a set of built-in controllers packaged within the <code class="language-plaintext highlighter-rouge">kube-controller-manager</code>. Each of these controllers operates by running a reconcile loop, which continuously ensures the alignment of the current state of the watched resource with its desired state.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">{</span>
  <span class="n">desiredState</span> <span class="o">:=</span> <span class="n">getDesiredState</span><span class="p">()</span>
  <span class="n">currentState</span> <span class="o">:=</span> <span class="n">getCurrentState</span><span class="p">()</span>
  <span class="n">makeChanges</span><span class="p">(</span><span class="n">desiredState</span><span class="p">,</span> <span class="n">currentState</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<!-- For example, if you create a Replicaset via the `kubectl`, the replication controller will notice this and it will delegate `kube-scheduler` to schedule the desired number of pods. When the pods are up and running, it will continously monitor the status of these pods via the `kube API server`. If a pod get terminated, the replication controller will again ask the `kube-schedular` to schedule a pod to compensate the terminated pod. Similarly Kubernetes is packaged and shipped with built in controllers for the -->

<h4 id="kubernetes-custom-controllers">Kubernetes Custom controllers</h4>

<p>It’s essential to be familiar with the following terms to understand the concept of custom controllers in Kubernetes.</p>

<ul>
  <li><strong>Custom Resources (CRs)</strong> enable you to extend the Kubernetes API and create domain specific objects that are managed by Kubernetes itself like any other built-in objects like Pods, Deployments etc.</li>
  <li><strong>Custom Resource Definition (CRDs)</strong> are simply a Kubenetes resource type that is used to register your Custom Resources (CRs) with the Kubernetes API server.</li>
  <li><strong>Custom controllers</strong> extend the functionality of Kubernetes by implementing custom logic for managing Custom Resources (CRs).</li>
</ul>

<p>So if you want to extend Kubernetes with your own custom logic,</p>

<ol>
  <li>Define a Custom Resource Definition (CRD) to let Kubernetes know about your Custom Resources (CRs).</li>
  <li>Run your own reconcile loop for the custom resource type by implementing a custom controller and deploying it in the Kubernetes cluster.</li>
  <li>Create Custom Resources (CRs) via a Kubernetes client like <code class="language-plaintext highlighter-rouge">kubectl</code>.</li>
</ol>

<p>Following diagram shows how custom controllers fit in with the Kubernetes control plane components and their interactions.</p>

<p align="center">
  <img alt="Kubernetes Custom Controllers" src="assets/images/custom-controller-overview.png" />
    <em>Kubernetes Custom Controllers</em>
</p>

<p>Custom controllers can be deployed as typical Kubernetes deployments.</p>

<p>Now that you have some basic understading about how the Kubernetes custom controllers fit in with other control plane components, let’s dig deeper into the internals of a custom controller.</p>

<h4 id="building-blocks-of-a-kubernetes-custom-controller">Building blocks of a Kubernetes custom controller</h4>

<p>The internal components of a custom controller can be categorized into <strong>two distinct groups</strong> based on their functionalities and implementation:</p>

<h6 id="1-kubernetes-client-go-components-shared-informer">1. Kubernetes Client Go components (Shared Informer)</h6>

<ul>
  <li>These components are initialized and provided out of the box by the <a href="https://github.com/kubernetes/client-go">Kubernetes Go client</a>.</li>
  <li>The developer implementing the custom controller has to initialize these components via the Shared Informer interface.</li>
  <li>Responsible for watching the Kubernetes API server for resource changes and notifying the event processing components of the custom controller.</li>
</ul>

<p><strong>Informer vs Shared Informer</strong></p>

<p>Evaluating the current state against the desired state requires the controller to interact with the Kubernetes API server to fetch object details. As the number of Kubernetes resources created grows, the frequency of API server calls made by controllers will significantly rise, potentially increasing exponentially. So to reduce the load on the Kubernetes API server, informers or shared informers are introduced.</p>

<p>Informers address this issue by retrieving object data and storing it in the local cache of the controller. The Informer then watches for any create, modify, and delete events that occur afterward. In scenarios where multiple controllers are monitoring a single object, each controller will independently update its local cache. This can result in excessive memory usage and the creation of multiple, potentially inconsistent cache data stores containing object data. This is where the Sharedinformer comes in.</p>

<p>The SharedInformer, as its name implies, is utilized to create a shared cache data store accessible to all controllers, thus resolving the issue of multiple controllers monitoring and updating a single resource or object within the cluster.</p>

<p>Shared informers consist of 4 main components.</p>

<ol>
  <li><a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/reflector.go">Reflector</a></li>
  <li><a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/fifo.go">Delta FIFO Queue</a></li>
  <li><a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/controller.go">Cache controller</a></li>
  <li><a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/index.go">Indexer</a></li>
</ol>

<h6 id="2-custom-controller-components">2. Custom controller components</h6>

<ul>
  <li>These components are implemented by the developer who’s writting the custom controller.</li>
  <li>Responsible for processing the events passed from the Shared Informer.</li>
  <li>Contains the actual reconcilation logic of the custom controller.</li>
</ul>

<p>Consist of 3 main components.</p>

<ol>
  <li>Resource Event handlers.</li>
  <li>Work Queue.</li>
  <li>Event processing function (Reconcile)</li>
</ol>

<p>Now let’s see how all these components work together and what tasks each of these components perform to achieve the desired functionality of the custom controller.</p>

<h4 id="internal-functionality-of-a-kubernetes-custom-controller">Internal functionality of a Kubernetes custom controller</h4>

<p>Following diagram shows the internal interactions between the components of a custom controller and the data flow between the components.</p>

<p align="center">
  <img alt="Custom controllers internals" src="assets/images/K8s-custom-controller.png" />
    <em>Custom controllers internals</em>
</p>

<h6 id="1-reflector-watches-the-kubernetes-api-server-using-listandwatch-mechanism">1. Reflector watches the Kubernetes API Server using ListAndWatch mechanism.</h6>

<p>Reflectors continuously watch the Kubernetes API server for changes in specific resources like Pods, Deployments or Custom Resources and enqueues the Delta FIFO store with events like <code class="language-plaintext highlighter-rouge">Add</code>, <code class="language-plaintext highlighter-rouge">Update</code>, <code class="language-plaintext highlighter-rouge">Delete</code> related to the resources being watched. To perform this, reflectors use the <code class="language-plaintext highlighter-rouge">ListAndWatch</code> mechanism provided by the Kubernetes API server.</p>

<p>When a reflector is initialized, it starts by listing all the resources it’s interested in. This initial listing provides a snapshot of the current state of those resources. After the initial listing, the reflector switches to a watch mode where it establishes a long-lived connection with the API server. The API server then notifies the reflector of any changes to the resources in real-time.</p>

<p>To examine the List and Watch capability of the Kubernetes API server, you can follow the following steps.</p>

<ul>
  <li>Execute <code class="language-plaintext highlighter-rouge">kubectl proxy</code> to call the Kubernetes API server without certificates or tokens.</li>
  <li>Execute <code class="language-plaintext highlighter-rouge">curl -s http://localhost:8001/api/v1/namespaces/default/pods</code> to list all the pods in default namespace.</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PodList"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"resourceVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"582837"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>Capture a resource version and execute <code class="language-plaintext highlighter-rouge">curl -s "http://localhost:8001/api/v1/pods?watch=true&amp;resourceVersion=582837"</code> to watch for pods from a specificed resource version onwards. This will establish a persistence HTTP connection with the Kubernetes API Server and the Kubernetes API server will send the resource updates as chunks.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="nt">-v</span> <span class="s2">"http://localhost:8001/api/v1/pods?watch=true&amp;resourceVersion=587961"</span> <span class="nt">-v</span>
<span class="k">*</span>   Trying 127.0.0.1:8001...
<span class="k">*</span> Connected to localhost <span class="o">(</span>127.0.0.1<span class="o">)</span> port 8001 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /api/v1/pods?watch<span class="o">=</span><span class="nb">true</span>&amp;resourceVersion<span class="o">=</span>587961 HTTP/1.1
<span class="o">&gt;</span> Host: localhost:8001
<span class="o">&gt;</span> User-Agent: curl/8.1.2
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span>
&lt; HTTP/1.1 200 OK
&lt; Audit-Id: 9f25e00a-1d6b-47d6-b818-be84ce7458eb
&lt; Cache-Control: no-cache, private
&lt; Content-Type: application/json
&lt; Date: Sat, 30 Sep 2023 08:33:01 GMT
&lt; X-Kubernetes-Pf-Flowschema-Uid: 2eeceae7-9692-4905-85ba-1ad01882320d
&lt; X-Kubernetes-Pf-Prioritylevel-Uid: 30e13e51-7784-4c62-acb5-b944f96ae4da
&lt; Transfer-Encoding: chunked
</code></pre></div></div>

<ul>
  <li>Execute <code class="language-plaintext highlighter-rouge">kubectl run nginx --image=nginx</code> and notice the <code class="language-plaintext highlighter-rouge">CREATE</code> event received through the other terminal in watch mode.</li>
</ul>

<p>The received events via the watch are called deltas and the deltas will be enqueued into the <a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/delta_fifo.go">Delta FIFO Queue</a>, which is an incremental first-in first-out queue.</p>

<h6 id="2-delta-fifo-queue-stores-the-resource-changes-as-deltas">2. Delta FIFO Queue stores the resource changes as deltas.</h6>

<p>This is a special store that maintains deltas, which is a structure containing the changed object and the type of change.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Delta</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Type</span>   <span class="n">DeltaType</span>
	<span class="n">Object</span> <span class="k">interface</span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The Delta objects in the queue will be eventually popped out and processed by the cache controller.</p>

<h6 id="3-cache-controller-popping-deltas-and-processing-deltas">3. Cache controller popping deltas and processing deltas</h6>

<p>When the cache controller is initiated, <a href="https://github.com/kubernetes/client-go/blob/6b97f71afcff4f2d6560c79e9e304cc31a8b4ef7/tools/cache/controller.go#L129">it starts 2 go routines</a>.</p>

<ol>
  <li>Creates a Reflector and runs the reflector in a separate go routine to watch resources in Kubernetes API server.</li>
  <li>Blocks its main go routine on the <a href="https://github.com/kubernetes/client-go/blob/6b97f71afcff4f2d6560c79e9e304cc31a8b4ef7/tools/cache/controller.go#L186">processLoop()</a> method which continously pop deltas from the Delta FIFO queue and process deltas.</li>
</ol>

<p><a href="https://github.com/kubernetes/client-go/blob/6b97f71afcff4f2d6560c79e9e304cc31a8b4ef7/tools/cache/controller.go#L186">processLoop()</a> method will invoke <a href="https://github.com/kubernetes/client-go/blob/6b97f71afcff4f2d6560c79e9e304cc31a8b4ef7/tools/cache/controller.go#L436">processDeltas()</a> method which will perform 2 main functions.</p>

<ol>
  <li>Update the indexer according to the detected change retrieved from the delta FIFO queue.</li>
  <li>Trigger the pre-registered Resource Event Handlers according to the event type. (These are the resource event handlers registered by the developer when creating a SharedInformer. In the resource event handlers, usually only some simple filtering is done, and then the event is added into the Work Queue)</li>
</ol>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sharedInformer</span><span class="o">.</span><span class="n">AddEventHandler</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="n">cache</span><span class="o">.</span><span class="n">ResourceEventHandlerFuncs</span><span class="p">{</span>
            <span class="n">AddFunc</span><span class="o">:</span>    <span class="n">onAdd</span><span class="p">,</span>
            <span class="n">DeleteFunc</span><span class="o">:</span> <span class="n">onDelete</span><span class="p">,</span>
            <span class="n">UpdateFunc</span><span class="o">:</span> <span class="n">onUpdate</span><span class="p">,</span>
        <span class="p">})</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">onAdd</code>, <code class="language-plaintext highlighter-rouge">onDelete</code> and <code class="language-plaintext highlighter-rouge">onUpdate</code> resource event handlers are functions implemented by the developer.</p>

<h6 id="4-resource-event-handlers-enqueue-the-object-key-to-the-work-queue">4. Resource event handlers enqueue the object key to the work queue</h6>

<p>Resource event handlers serve as callback functions that the Shared Informer calls to deliver objects to the controller’s event processing functions. The common practice for writing these functions involves retrieving the key associated with the dispatched object (<code class="language-plaintext highlighter-rouge">namespace/name</code>) and enqueueing that key in the work queue for subsequent processing.</p>

<p>The work queue <strong>decouples the event arrival from processing</strong>, allowing the controller to process events in a controlled and predictable manner, preventing event processing bottlenecks. For example, Shared Informers may operate at different speeds than controller event processing functions, and work queues help prevent the Shared Informer from overloading a slower controller event processor.</p>

<h6 id="5-dequeueing-events-from-the-work-queue-and-reconciliation">5. Dequeueing events from the work queue and reconciliation</h6>

<p>Event processing functions are the functions that you implement in your code to process items from the work queue. There can be one or more other functions that do the actual processing.</p>

<p>These functions will typically use the Indexer to retrieve the object corresponding to the key and perform the actual event processing logic you have implemented.</p>

<p>Multiple go routines can be spawned to process event updates and each of these worker go routines will call <code class="language-plaintext highlighter-rouge">processNextWorkItem</code> which will dequeue object keys from the work queue and call <code class="language-plaintext highlighter-rouge">syncHandler</code> method to perform reconcilation logic.</p>

<p>Depending on the reconcilation logic, you may need to call the Kubernetes API server or any other external services. And mostly importantly, once the reconciliation logic is performed, the status of the resource should be updated and typically the performed actions is added into the Events array.</p>

<p>If you are using a framework like <a href="https://github.com/kubernetes-sigs/kubebuilder">Kubebuilder</a> or <a href="https://sdk.operatorframework.io/">OperatorSDK</a>, this is the point where you write reconciliation logic inside the <code class="language-plaintext highlighter-rouge">Reconcile()</code> method of the generated controller code.</p>

<h4 id="summary">Summary</h4>

<p>In summary, the following sequence of events take place inside the Kubernetes custom controller.</p>

<ol>
  <li>Reflector watches Kubernetes API server and add resource changes (deltas) to Delta FIFO Queue.</li>
  <li>Cache controller pops these changes out from the Delta FIFO Queue and update the indexer.</li>
  <li>Cache controller trigger the pre-registered resource event handlers.</li>
  <li>Pre-registered resource event handlers filters the events and add the object keys to the work queue.</li>
  <li>Custom controller event processing functions pops out the object keys, retrieve the object using the keys from the indexer and perform reconcilation logic.</li>
  <li>After performing reconcilation logic, custom controller updates the status of the object by calling the Kubernetes API server.</li>
</ol>

<p>Now to get started with implementing a custom controller, you can use this <a href="https://github.com/kubernetes/sample-controller">sample controller</a> from the Kubernetes community as the starting point.</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            <!--  -->

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/blog/assets/images/lahiru.jpg" alt="lahiru" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/blog/author/lahiru">Lahiru Udayanga</a></h4>
                                
                                    <p>Greetings! I go by the name nomadxd on all of my digital channels. My real name is Lahiru Udayanga De Silva. I'm a software engineer by profession specialized in distributed systems, kubernetes and cloud native API management technologies.</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/blog/author/lahiru">Read More</a>
                        </div>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/blog//assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Nomad's Blog &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/blog/tag/tech/">Tech</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/blog/multi-cluster-networking-with-cilium-cluster-mesh">Multi cluster networking with Cilium Cluster Mesh</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/blog/how-to-implement-a-k8s-operator-like-a-ninja">How to implement a K8s operator like a Ninja</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/blog/my-cka-story">How I passed my CKA exam on the first attempt</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/blog/tag/tech/">
                                
                                    See all 5 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/blog/multi-cluster-networking-with-cilium-cluster-mesh">
                <div class="post-card-image" style="background-image: url(/blog/assets/images/cilium.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/blog/multi-cluster-networking-with-cilium-cluster-mesh">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Tech</span>
                            
                        
                    

                    <h2 class="post-card-title">Multi cluster networking with Cilium Cluster Mesh</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>As organizations increasingly adopt distributed architectures and scale their Kubernetes deployments, the need for robust networking and security solutions that can seamlessly operate across multiple clusters becomes paramount. In this blog, we will</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/blog/assets/images/lahiru.jpg" alt="Lahiru Udayanga" />
                        
                        <span class="post-card-author">
                            <a href="/blog/author/lahiru/">Lahiru Udayanga</a>
                        </span>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      14 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/blog/how-to-implement-a-k8s-operator-like-a-ninja">
                <div class="post-card-image" style="background-image: url(/blog/assets/images/k8s-operator-kube-builder.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/blog/how-to-implement-a-k8s-operator-like-a-ninja">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Tech</span>
                            
                        
                    

                    <h2 class="post-card-title">How to implement a K8s operator like a Ninja</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p>Kubernetes has emerged as the widely accepted standard for deploying and running modern cloud-native applications. With its declarative approach using YAML, it offers a straightforward and intuitive method to define the desired infrastructure</p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/blog/assets/images/lahiru.jpg" alt="Lahiru Udayanga" />
                        
                        <span class="post-card-author">
                            <a href="/blog/author/lahiru/">Lahiru Udayanga</a>
                        </span>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      7 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="/blog/">
            
                <img src="/blog//assets/images/favicon.png" alt="Nomad's Blog icon" />
            
            <span>Nomad's Blog</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Deep dive into Kubernetes custom controllers</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Deep+dive+into+Kubernetes+custom+controllers&amp;url=https://nomadxd.github.io/NomadXD/deep-dive-into-kubernetes-custom-controllers"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://nomadxd.github.io/NomadXD/deep-dive-into-kubernetes-custom-controllers"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="/blog/">Nomad's Blog</a> &copy; 2024</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyllt/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/blog/">Latest Posts</a>
                    <a href="https://facebook.com/lahiru97udayanga" target="_blank" rel="noopener">Facebook</a>
                    <a href="https://twitter.com/NomadXDDDD" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/blog/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/blog/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
<!-- Google tag (gtag.js) -->
<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=G-C0VWGXL63G"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "G-C0VWGXL63G");
</script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
